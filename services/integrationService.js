// services/integrationService.js - Servi√ßo de integra√ß√£o consolidado
// Substitui homeService.js e outras duplicatas

import AppState from '../state/appState.js';
import { carregarDashboard, recarregarDashboard } from '../feature/dashboard.js';
import { reactiveUI, setupHomeReactivity, HomeAnimations, stateNotifier } from '../utils/reactiveUI.js';
import { weeklyPlanManager } from '../hooks/useWeeklyPlan.js';

/**
 * Servi√ßo principal de integra√ß√£o da aplica√ß√£o
 * Consolida funcionalidades de dashboard, reactive UI e home manager
 */
class IntegrationService {
    constructor() {
        this.isInitialized = false;
        this.activeComponents = new Map();
        this.eventListeners = [];
        this.initTime = null;
    }

    /**
     * Inicializar servi√ßo completo
     */
    async initialize() {
        if (this.isInitialized) {
            console.log('[IntegrationService] J√° inicializado');
            return;
        }

        console.log('[IntegrationService] üöÄ Inicializando integra√ß√£o completa...');

        try {
            // 1. Verificar usu√°rio atual
            const currentUser = AppState.get('currentUser');
            if (!currentUser) {
                console.warn('[IntegrationService] Nenhum usu√°rio logado');
                return false;
            }

            // 2. Inicializar sistema reativo
            await this.initializeReactiveSystem();

            // 3. Inicializar weekly plan manager
            await this.initializeWeeklyPlan(currentUser.id);

            // 4. Carregar dashboard
            await this.loadDashboard();

            // 5. Configurar componentes avan√ßados
            await this.setupAdvancedComponents();

            // 6. Configurar listeners globais
            this.setupGlobalListeners();

            this.isInitialized = true;
            this.initTime = Date.now();
            console.log('[IntegrationService] ‚úÖ Integra√ß√£o inicializada com sucesso!');

            return true;

        } catch (error) {
            console.error('[IntegrationService] Erro na inicializa√ß√£o:', error);
            return false;
        }
    }

    /**
     * Inicializar sistema reativo
     */
    async initializeReactiveSystem() {
        try {
            if (!reactiveUI.isInitialized) {
                reactiveUI.init();
            }
            
            setupHomeReactivity();
            stateNotifier.setup();
            
            console.log('[IntegrationService] ‚úÖ Sistema reativo inicializado');
            
        } catch (error) {
            console.error('[IntegrationService] Erro no sistema reativo:', error);
        }
    }

    /**
     * Inicializar weekly plan manager
     */
    async initializeWeeklyPlan(userId) {
        try {
            const result = await weeklyPlanManager.initialize(userId);
            
            if (result.needsPlanning) {
                console.log('[IntegrationService] ‚ö†Ô∏è Usu√°rio precisa configurar planejamento');
                // N√£o redirecionar automaticamente, deixar para o usu√°rio decidir
            } else {
                console.log('[IntegrationService] ‚úÖ Plano semanal carregado');
                AppState.set('weekPlan', result.plan);
            }
            
            return result;
            
        } catch (error) {
            console.error('[IntegrationService] Erro no weekly plan:', error);
            return { needsPlanning: true };
        }
    }

    /**
     * Carregar dashboard
     */
    async loadDashboard() {
        try {
            await carregarDashboard();
            console.log('[IntegrationService] ‚úÖ Dashboard carregado');
            
        } catch (error) {
            console.warn('[IntegrationService] Erro no dashboard:', error);
            // N√£o √© cr√≠tico, continuar
        }
    }

    /**
     * Configurar componentes avan√ßados
     */
    async setupAdvancedComponents() {
        try {
            // Widget de m√©tricas avan√ßado (se dispon√≠vel)
            if (window.MetricsWidget) {
                const metricsContainer = document.getElementById('metrics-advanced-container');
                if (metricsContainer) {
                    const metricsWidget = new window.MetricsWidget('metrics-advanced-container');
                    await metricsWidget.init();
                    
                    this.activeComponents.set('metricsWidget', metricsWidget);
                    console.log('[IntegrationService] ‚úÖ MetricsWidget inicializado');
                }
            }

            // Configurar anima√ß√µes de entrada
            this.setupEntryAnimations();

        } catch (error) {
            console.error('[IntegrationService] Erro nos componentes avan√ßados:', error);
        }
    }

    /**
     * Configurar anima√ß√µes de entrada
     */
    setupEntryAnimations() {
        try {
            // Animar componentes principais
            setTimeout(() => HomeAnimations.animateCurrentWorkout(), 200);
            setTimeout(() => HomeAnimations.animateWeekIndicators(), 400);
            setTimeout(() => HomeAnimations.animateMetrics(), 600);

            console.log('[IntegrationService] ‚úÖ Anima√ß√µes configuradas');

        } catch (error) {
            console.error('[IntegrationService] Erro nas anima√ß√µes:', error);
        }
    }

    /**
     * Configurar listeners globais
     */
    setupGlobalListeners() {
        // Listener para mudan√ßas de usu√°rio
        const userListener = AppState.subscribe('currentUser', async (newUser) => {
            if (newUser) {
                console.log('[IntegrationService] Usu√°rio alterado, reinicializando...');
                await this.reinitialize();
            }
        });

        // Listener para mudan√ßas no plano semanal
        const planListener = AppState.subscribe('weekPlan', (newPlan) => {
            if (newPlan) {
                console.log('[IntegrationService] Plano semanal atualizado');
                this.refreshDashboard();
            }
        });

        // Listener para visibilidade da p√°gina
        const visibilityListener = () => {
            if (!document.hidden) {
                console.log('[IntegrationService] P√°gina voltou ao foco, atualizando...');
                this.refreshDashboard();
            }
        };

        document.addEventListener('visibilitychange', visibilityListener);

        // Armazenar listeners para cleanup
        this.eventListeners.push(
            userListener,
            planListener,
            () => document.removeEventListener('visibilitychange', visibilityListener)
        );

        console.log('[IntegrationService] ‚úÖ Listeners globais configurados');
    }

    /**
     * Reinicializar servi√ßo
     */
    async reinitialize() {
        console.log('[IntegrationService] Reinicializando...');
        
        // Limpar estado atual
        this.cleanup();
        
        // Inicializar novamente
        this.isInitialized = false;
        await this.initialize();
    }

    /**
     * Atualizar dashboard
     */
    async refreshDashboard() {
        try {
            await recarregarDashboard();
            console.log('[IntegrationService] ‚úÖ Dashboard atualizado');
            
        } catch (error) {
            console.error('[IntegrationService] Erro ao atualizar dashboard:', error);
        }
    }

    /**
     * Verificar status do servi√ßo
     */
    getStatus() {
        const currentUser = AppState.get('currentUser');
        const weekPlan = AppState.get('weekPlan');
        
        return {
            isInitialized: this.isInitialized,
            hasUser: !!currentUser,
            hasWeekPlan: !!weekPlan,
            activeComponents: Array.from(this.activeComponents.keys()),
            userName: currentUser?.nome || null
        };
    }

    /**
     * Obter m√©tricas de performance
     */
    getPerformanceMetrics() {
        return {
            componentsLoaded: this.activeComponents.size,
            listenersActive: this.eventListeners.length,
            memoryUsage: performance.memory ? {
                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)
            } : null,
            uptime: this.isInitialized ? Date.now() - this.initTime : 0
        };
    }

    /**
     * Limpar recursos
     */
    cleanup() {
        console.log('[IntegrationService] Limpando recursos...');

        // Limpar componentes ativos
        this.activeComponents.forEach((component, name) => {
            try {
                if (component && typeof component.destroy === 'function') {
                    component.destroy();
                }
                console.log(`[IntegrationService] Componente ${name} limpo`);
            } catch (error) {
                console.warn(`[IntegrationService] Erro ao limpar ${name}:`, error);
            }
        });
        this.activeComponents.clear();

        // Limpar event listeners
        this.eventListeners.forEach(cleanup => {
            try {
                cleanup();
            } catch (error) {
                console.warn('[IntegrationService] Erro ao limpar listener:', error);
            }
        });
        this.eventListeners = [];

        console.log('[IntegrationService] ‚úÖ Recursos limpos');
    }

    /**
     * Destruir servi√ßo
     */
    destroy() {
        console.log('[IntegrationService] Destruindo servi√ßo...');
        
        this.cleanup();
        this.isInitialized = false;
        
        console.log('[IntegrationService] ‚úÖ Servi√ßo destru√≠do');
    }
}

// Inst√¢ncia global
export const integrationService = new IntegrationService();

// Fun√ß√µes de conveni√™ncia para compatibilidade
export async function initializeIntegration() {
    return await integrationService.initialize();
}

export function getIntegrationStatus() {
    return integrationService.getStatus();
}

export function cleanupIntegration() {
    integrationService.cleanup();
}

// Fun√ß√£o global para inicializa√ß√£o completa da home
window.initializeHomeComplete = async function() {
    const result = await integrationService.initialize();
    
    if (!result) {
        console.warn('[initializeHomeComplete] Falha na inicializa√ß√£o');
        if (window.showNotification) {
            window.showNotification('Erro ao inicializar componentes da home', 'error');
        }
    }
    
    return result;
};

// Fun√ß√£o para debug (desenvolvimento)
if (typeof window !== 'undefined' && 
    (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1'))) {
    
    window.debugIntegration = {
        service: integrationService,
        status: () => integrationService.getStatus(),
        metrics: () => integrationService.getPerformanceMetrics(),
        reinit: () => integrationService.reinitialize(),
        cleanup: () => integrationService.cleanup()
    };
}