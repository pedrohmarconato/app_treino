<!DOCTYPE html>
<html>
<head>
    <title>Corre√ß√£o de Duplicatas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>üîß Corre√ß√£o de Duplicatas no Planejamento</h1>
    <p>Este script corrige o problema de m√∫ltiplas linhas na tabela planejamento_semanal que est√° causando erro 406.</p>
    
    <button onclick="verificarDuplicatas()">1. Verificar Duplicatas</button>
    <button onclick="corrigirDuplicatas()">2. Corrigir Duplicatas</button>
    <button onclick="testarTreino()">3. Testar Treino</button>
    <button onclick="correcaoCompleta()">üöÄ Corre√ß√£o Completa</button>
    
    <div id="log" class="log"></div>

    <script>
        // Fun√ß√£o para log
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${color}">${new Date().toLocaleTimeString()} - ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Fun√ß√£o para verificar duplicatas
        async function verificarDuplicatas() {
            log('üîç Verificando duplicatas...');
            
            try {
                const { data: duplicatas, error } = await supabase
                    .from('planejamento_semanal')
                    .select('*')
                    .eq('usuario_id', 3)
                    .eq('ano', 2025)
                    .eq('semana_treino', 1)
                    .eq('dia_semana', 3)
                    .order('id', { ascending: false });
                    
                if (error) {
                    log(`‚ùå Erro ao verificar duplicatas: ${error.message}`, 'error');
                    return false;
                }
                
                log(`üìä Encontradas ${duplicatas.length} linhas para o mesmo dia`);
                
                if (duplicatas.length > 1) {
                    log(`‚ö†Ô∏è ${duplicatas.length - 1} duplicatas encontradas!`, 'warning');
                    duplicatas.forEach((item, index) => {
                        log(`   ${index + 1}. ID: ${item.id}, Treino: ${item.treino}, Criado: ${new Date(item.created_at).toLocaleString()}`);
                    });
                } else {
                    log('‚úÖ Nenhuma duplicata encontrada', 'success');
                }
                
                return duplicatas;
                
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o para corrigir duplicatas
        async function corrigirDuplicatas() {
            log('üîß Iniciando corre√ß√£o de duplicatas...');
            
            try {
                // 1. Buscar todas as duplicatas
                const { data: duplicatas, error: errorDuplicatas } = await supabase
                    .from('planejamento_semanal')
                    .select('*')
                    .eq('usuario_id', 3)
                    .eq('ano', 2025)
                    .eq('semana_treino', 1)
                    .eq('dia_semana', 3)
                    .order('id', { ascending: false });
                    
                if (errorDuplicatas) {
                    log(`‚ùå Erro ao buscar duplicatas: ${errorDuplicatas.message}`, 'error');
                    return false;
                }
                
                if (duplicatas.length <= 1) {
                    log('‚úÖ Nenhuma duplicata para corrigir', 'success');
                    return true;
                }
                
                // 2. Manter apenas a mais recente
                const planejamentoManter = duplicatas[0];
                const planejamentosRemover = duplicatas.slice(1);
                
                log(`üìã Mantendo planejamento ID ${planejamentoManter.id} (${planejamentoManter.treino})`);
                log(`üóëÔ∏è Removendo ${planejamentosRemover.length} duplicatas...`);
                
                // 3. Remover duplicatas
                for (const planejamento of planejamentosRemover) {
                    log(`   Removendo ID ${planejamento.id}...`);
                    
                    const { error: errorRemover } = await supabase
                        .from('planejamento_semanal')
                        .delete()
                        .eq('id', planejamento.id);
                        
                    if (errorRemover) {
                        log(`   ‚ùå Erro ao remover ${planejamento.id}: ${errorRemover.message}`, 'error');
                    } else {
                        log(`   ‚úÖ Removido ${planejamento.id}`);
                    }
                }
                
                // 4. Verificar corre√ß√£o
                const { data: verificacao, error: errorVerificacao } = await supabase
                    .from('planejamento_semanal')
                    .select('*')
                    .eq('usuario_id', 3)
                    .eq('ano', 2025)
                    .eq('semana_treino', 1)
                    .eq('dia_semana', 3);
                    
                if (errorVerificacao) {
                    log(`‚ùå Erro na verifica√ß√£o: ${errorVerificacao.message}`, 'error');
                    return false;
                }
                
                if (verificacao.length === 1) {
                    log('üéâ Corre√ß√£o bem-sucedida!', 'success');
                    return true;
                } else {
                    log(`‚ö†Ô∏è Ainda restam ${verificacao.length} linhas`, 'warning');
                    return false;
                }
                
            } catch (error) {
                log(`‚ùå Erro na corre√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o para testar se o treino funciona
        async function testarTreino() {
            log('üß™ Testando se o treino pode ser iniciado...');
            
            try {
                // Usar o m√©todo corrigido
                const { data: planejamento, error } = await supabase
                    .from('planejamento_semanal')
                    .select('*')
                    .eq('usuario_id', 3)
                    .eq('ano', 2025)
                    .eq('semana_treino', 1)
                    .eq('dia_semana', 3)
                    .order('id', { ascending: false })
                    .limit(1);
                    
                if (error) {
                    log(`‚ùå Erro no teste: ${error.message}`, 'error');
                    return false;
                }
                
                const planejamentoUnico = planejamento?.[0];
                
                if (!planejamentoUnico) {
                    log('‚ùå Nenhum planejamento encontrado', 'error');
                    return false;
                }
                
                log(`‚úÖ Planejamento encontrado: ${planejamentoUnico.treino}`, 'success');
                
                if (planejamentoUnico.exercicios && planejamentoUnico.exercicios.length > 0) {
                    log(`‚úÖ ${planejamentoUnico.exercicios.length} exerc√≠cios encontrados`, 'success');
                    log('üéâ Treino pode ser iniciado normalmente!', 'success');
                    return true;
                } else {
                    log('‚ö†Ô∏è Planejamento sem exerc√≠cios', 'warning');
                    return false;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o para corre√ß√£o completa
        async function correcaoCompleta() {
            log('üöÄ Iniciando corre√ß√£o completa...', 'success');
            
            // 1. Verificar duplicatas
            const duplicatas = await verificarDuplicatas();
            if (!duplicatas) return;
            
            // 2. Corrigir se necess√°rio
            if (duplicatas.length > 1) {
                const correcaoOK = await corrigirDuplicatas();
                if (!correcaoOK) {
                    log('‚ùå Corre√ß√£o falhou', 'error');
                    return;
                }
            }
            
            // 3. Testar treino
            const testeOK = await testarTreino();
            
            if (testeOK) {
                log('üéâ PROBLEMA CORRIGIDO COM SUCESSO!', 'success');
                log('‚úÖ Agora o treino pode ser iniciado e finalizado normalmente', 'success');
                log('üîÑ Recarregue a p√°gina do app para testar', 'success');
            } else {
                log('‚ö†Ô∏è Corre√ß√£o parcial - pode haver outros problemas', 'warning');
            }
        }

        // Verificar se supabase est√° dispon√≠vel
        if (typeof supabase === 'undefined') {
            log('‚ùå Supabase n√£o est√° dispon√≠vel. Abra esta p√°gina no contexto do seu app.', 'error');
        } else {
            log('‚úÖ Supabase conectado. Pronto para corrigir duplicatas.', 'success');
        }
    </script>
</body>
</html>